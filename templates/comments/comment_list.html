<!--This loads in the bootstrap css ands javascript files-->
<!-- TODO: remove when we have a base template that imports everything -->
{% extends "base.html" %}
{% block content %}
<div class = "container">
    <div class="comment-pic col-sm-offset-4 col-xs-offset-1">
    <img src='{{MEDIA_URL}}{{profile_picture}}'>
    </div>
<table class="table table-striped table-bordered" style="word-wrap: break-word; table-layout:fixed;">
    <tbody>

        {% if rush_comments %}
            {% for rush_comment in rush_comments %}

            <tr>
                <td class="col-md-2">
                  <p>{{ rush_comment.created_at.date }}</p>
                  {% if rush_comment.event %}<p><b>Event: </b>{{ rush_comment.event }}</p>{% endif %}
                </td>
                <td class="col-md-2">
                    <p>{{ rush_comment.user.email}}</p>
                </td>
                <td class="col-md-8" style="word-wrap: break-word;">
                    <p>{{ rush_comment.comment }}</p>
                </td>
            </tr>

            {% endfor %}
        {% else %}
            <h4 class="js-no-comment">no comments about this rush</h4>
        {% endif %}
    </tbody>

</table>

<div style="width:70%; margin:0 auto;">
    {% load crispy_forms_tags %}
    {% crispy CommentForm %}
</div>
</div>

<script>
$(document).ready(function(){
  var form = $('form');
  var submit = $('#submit-id-submit');
  var $noComment = $('.js-no-comment');

  form.on('submit', function(e) {
    // prevent default action
    e.preventDefault();
    // send ajax request
    $.ajax({
      url: '/comments/new/',
      type: 'POST',
      cache: false,
      data: form.serialize(), //form serizlize data
      beforeSend: function(){
        // change submit button value text and disabled it
        submit.val('Submitting...').attr('disabled', 'disabled');
      },
      success: function(data){
        // Append with fadeIn see http://stackoverflow.com/a/978731
        if(data.success == true) {
          console.log(data);
          var item = $('<tr><td class="col-md-2">Just now</td><td class="col-md-2">' + data.email + '</td><td class="col-md-8">' + data.comment + '</td></tr>').hide()
          $('table > tbody:last').append(item);
          item.fadeIn("slow");
          form.trigger('reset');
          submit.val('Submit Comment').removeAttr('disabled');
          // todo: if there isnt a $noComment then will js bug out?
          $noComment.hide();
        } else if (data.success == false) {
          alert ("You are missing a field this is not complete");
          submit.val('Submit Comment').removeAttr('disabled');
        }
      },
      error: function(e){
        alert(e);
      }
    });
  });
});
</script>

{% endblock %}